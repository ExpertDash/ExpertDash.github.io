/**
 * Manages all systems
 */
export default class Systems {
    constructor() {
        this.registry = new Map();
        this.dependencies = new Map();
    }
    /**
     * Add a new system
     * @param systems System classe or instance
     */
    add(system, order = {}) {
        let ctor;
        let instance;
        switch (typeof system) {
            case "function":
                ctor = system;
                instance = new ctor();
                break;
            case "object":
                instance = system;
                ctor = instance.constructor;
                break;
        }
        if (this.registry.has(ctor))
            throw new Error(`'${ctor.name}' already present in this set of systems`);
        this.registry.set(ctor, instance);
        let addDependencies = (sys, deps) => {
            let set;
            if (this.dependencies.has(sys))
                set = this.dependencies.get(sys);
            else {
                set = new Set();
                this.dependencies.set(sys, set);
            }
            for (let ctor of deps)
                set.add(ctor);
        };
        addDependencies(ctor, order.after ?? []);
        if (order.before)
            for (let system of order.before)
                addDependencies(system, [ctor]);
    }
    /**
     * Gets the system instance
     * @param ctor System class
     */
    get(ctor) {
        return this.registry.get(ctor);
    }
    /**
     * Remove existing systems
     * @param ctors System classes
     */
    remove(...ctors) {
        for (let ctor of ctors)
            this.registry.delete(ctor);
    }
    /**
     * Generates an iterator for the system instances with an order considering dependencies
     */
    [Symbol.iterator]() {
        let edges = new Map(this.dependencies);
        let list = [];
        let set = new Set([...edges]
            .filter(v => v[1].size == 0)
            .map(v => v[0]));
        while (set.size > 0) {
            let it = set[Symbol.iterator]();
            let { value: n } = it.next();
            list.push(n);
            set.delete(n);
            for (let m of [...edges].filter(v => v[1].has(n)).map(v => v[0])) {
                let incoming = edges.get(m);
                incoming.delete(n);
                if (incoming.size == 0)
                    set.add(m);
            }
            if (edges.get(n).size == 0)
                edges.delete(n);
        }
        if (edges.size > 0) {
            let s = "Circularaly dependent systems detected";
            [...edges].forEach(v => [...v[1]].forEach(from => s += `\n\t${from.name} -> ${v[0].name}`));
            throw new Error(s);
        }
        return [...this.registry.values()].sort((a, b) => {
            let ctorA = a.constructor;
            let ctorB = b.constructor;
            return list.indexOf(ctorA) - list.indexOf(ctorB);
        }).values();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3lzdGVtcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lY3Mvc3lzdGVtcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFLQTs7R0FFRztBQUNILE1BQU0sQ0FBQyxPQUFPLE9BQU8sT0FBTztJQUE1QjtRQUNrQixhQUFRLEdBQXFDLElBQUksR0FBRyxFQUFFLENBQUE7UUFDdEQsaUJBQVksR0FBdUQsSUFBSSxHQUFHLEVBQUUsQ0FBQTtJQTZHOUYsQ0FBQztJQTNHQTs7O09BR0c7SUFDSSxHQUFHLENBQUMsTUFBNkMsRUFBRSxRQUFzQixFQUFFO1FBQ2pGLElBQUksSUFBeUIsQ0FBQTtRQUM3QixJQUFJLFFBQWdCLENBQUE7UUFFcEIsUUFBTyxPQUFPLE1BQU0sRUFBRTtZQUNyQixLQUFLLFVBQVU7Z0JBQ2QsSUFBSSxHQUFHLE1BQW9DLENBQUE7Z0JBQzNDLFFBQVEsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFBO2dCQUNyQixNQUFLO1lBQ04sS0FBSyxRQUFRO2dCQUNaLFFBQVEsR0FBRyxNQUFnQixDQUFBO2dCQUMzQixJQUFJLEdBQUcsUUFBUSxDQUFDLFdBQWtDLENBQUE7Z0JBQ2xELE1BQUs7U0FDTjtRQUVELElBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSwwQ0FBMEMsQ0FBQyxDQUFBO1FBRXpFLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUVqQyxJQUFJLGVBQWUsR0FBRyxDQUFDLEdBQXdCLEVBQUUsSUFBMkIsRUFBRSxFQUFFO1lBQy9FLElBQUksR0FBNkIsQ0FBQTtZQUVqQyxJQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztnQkFDNUIsR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFD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QUcsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUU1RixNQUFNLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ2xCO1FBRUQsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNoRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsV0FBa0MsQ0FBQTtZQUNoRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsV0FBa0MsQ0FBQTtZQUVoRCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNqRCxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUNaLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTeXN0ZW0gZnJvbSBcIi4vc3lzdGVtLmpzXCJcclxuXHJcbnR5cGUgQ29uc3RydWN0b3I8VD4gPSBuZXcoLi4uYXJnczogYW55W10pID0+IFRcclxudHlwZSBEZWZhdWx0Q29uc3RydWN0b3I8VD4gPSBuZXcoKSA9PiBUXHJcblxyXG4vKipcclxuICogTWFuYWdlcyBhbGwgc3lzdGVtc1xyXG4gKi9cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3lzdGVtcyB7XHJcblx0cHJpdmF0ZSByZWFkb25seSByZWdpc3RyeTogTWFwPENvbnN0cnVjdG9yPFN5c3RlbT4sIFN5c3RlbT4gPSBuZXcgTWFwKClcclxuXHRwcml2YXRlIHJlYWRvbmx5IGRlcGVuZGVuY2llczogTWFwPENvbnN0cnVjdG9yPFN5c3RlbT4sIFNldDxDb25zdHJ1Y3RvcjxTeXN0ZW0+Pj4gPSBuZXcgTWFwKClcclxuXHJcblx0LyoqXHJcblx0ICogQWRkIGEgbmV3IHN5c3RlbVxyXG5cdCAqIEBwYXJhbSBzeXN0ZW1zIFN5c3RlbSBjbGFzc2Ugb3IgaW5zdGFuY2VcclxuXHQgKi9cclxuXHRwdWJsaWMgYWRkKHN5c3RlbTogKFN5c3RlbSB8IERlZmF1bHRDb25zdHJ1Y3RvcjxTeXN0ZW0+KSwgb3JkZXI6IFN5c3RlbS5PcmRlciA9IHt9KTogdm9pZCB7XHJcblx0XHRsZXQgY3RvcjogQ29uc3RydWN0b3I8U3lzdGVtPlxyXG5cdFx0bGV0IGluc3RhbmNlOiBTeXN0ZW1cclxuXHJcblx0XHRzd2l0Y2godHlwZW9mIHN5c3RlbSkge1xyXG5cdFx0XHRjYXNlIFwiZnVuY3Rpb25cIjpcclxuXHRcdFx0XHRjdG9yID0gc3lzdGVtIGFzIERlZmF1bHRDb25zdHJ1Y3RvcjxTeXN0ZW0+XHJcblx0XHRcdFx0aW5zdGFuY2UgPSBuZXcgY3RvcigpXHJcblx0XHRcdFx0YnJlYWtcclxuXHRcdFx0Y2FzZSBcIm9iamVjdFwiOlxyXG5cdFx0XHRcdGluc3RhbmNlID0gc3lzdGVtIGFzIFN5c3RlbVxyXG5cdFx0XHRcdGN0b3IgPSBpbnN0YW5jZS5jb25zdHJ1Y3RvciBhcyBDb25zdHJ1Y3RvcjxTeXN0ZW0+XHJcblx0XHRcdFx0YnJlYWtcclxuXHRcdH1cclxuXHJcblx0XHRpZih0aGlzLnJlZ2lzdHJ5LmhhcyhjdG9yKSlcclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGAnJHtjdG9yLm5hbWV9JyBhbHJlYWR5IHByZXNlbnQgaW4gdGhpcyBzZXQgb2Ygc3lzdGVtc2ApXHJcblxyXG5cdFx0dGhpcy5yZWdpc3RyeS5zZXQoY3RvciwgaW5zdGFuY2UpXHJcblxyXG5cdFx0bGV0IGFkZERlcGVuZGVuY2llcyA9IChzeXM6IENvbnN0cnVjdG9yPFN5c3RlbT4sIGRlcHM6IENvbnN0cnVjdG9yPFN5c3RlbT5bXSkgPT4ge1xyXG5cdFx0XHRsZXQgc2V0OiBTZXQ8Q29uc3RydWN0b3I8U3lzdGVtPj5cclxuXHJcblx0XHRcdGlmKHRoaXMuZGVwZW5kZW5jaWVzLmhhcyhzeXMpKVxyXG5cdFx0XHRcdHNldCA9IHRoaXMuZGVwZW5kZW5jaWVzLmdldChzeXMpXHJcblx0XHRcdGVsc2Uge1xyXG5cdFx0XHRcdHNldCA9IG5ldyBTZXQoKVxyXG5cdFx0XHRcdHRoaXMuZGVwZW5kZW5jaWVzLnNldChzeXMsIHNldClcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Zm9yKGxldCBjdG9yIG9mIGRlcHMpXHJcblx0XHRcdFx0c2V0LmFkZChjdG9yKVxyXG5cdFx0fVxyXG5cclxuXHRcdGFkZERlcGVuZGVuY2llcyhjdG9yLCBvcmRlci5hZnRlciA/PyBbXSlcclxuXHJcblx0XHRpZihvcmRlci5iZWZvcmUpXHJcblx0XHRcdGZvcihsZXQgc3lzdGVtIG9mIG9yZGVyLmJlZm9yZSlcclxuXHRcdFx0XHRhZGREZXBlbmRlbmNpZXMoc3lzdGVtLCBbY3Rvcl0pXHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBHZXRzIHRoZSBzeXN0ZW0gaW5zdGFuY2VcclxuXHQgKiBAcGFyYW0gY3RvciBTeXN0ZW0gY2xhc3NcclxuXHQgKi9cclxuXHRwdWJsaWMgZ2V0PFQgZXh0ZW5kcyBTeXN0ZW0+KGN0b3I6IENvbnN0cnVjdG9yPFQ+KTogVCB7XHJcblx0XHRyZXR1cm4gdGhpcy5yZWdpc3RyeS5nZXQoY3RvcikgYXMgVFxyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogUmVtb3ZlIGV4aXN0aW5nIHN5c3RlbXNcclxuXHQgKiBAcGFyYW0gY3RvcnMgU3lzdGVtIGNsYXNzZXNcclxuXHQgKi9cclxuXHRwdWJsaWMgcmVtb3ZlKC4uLmN0b3JzOiBDb25zdHJ1Y3RvcjxTeXN0ZW0+W10pOiB2b2lkIHtcclxuXHRcdGZvcihsZXQgY3RvciBvZiBjdG9ycylcclxuXHRcdFx0dGhpcy5yZWdpc3RyeS5kZWxldGUoY3RvcilcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIEdlbmVyYXRlcyBhbiBpdGVyYXRvciBmb3IgdGhlIHN5c3RlbSBpbnN0YW5jZXMgd2l0aCBhbiBvcmRlciBjb25zaWRlcmluZyBkZXBlbmRlbmNpZXNcclxuXHQgKi9cclxuXHRwdWJsaWMgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxTeXN0ZW0+IHtcclxuXHRcdGxldCBlZGdlcyA9IG5ldyBNYXA8Q29uc3RydWN0b3I8U3lzdGVtPiwgU2V0PENvbnN0cnVjdG9yPFN5c3RlbT4+Pih0aGlzLmRlcGVuZGVuY2llcylcclxuXHRcdGxldCBsaXN0OiBDb25zdHJ1Y3RvcjxTeXN0ZW0+W10gPSBbXVxyXG5cdFx0bGV0IHNldDogU2V0PENvbnN0cnVjdG9yPFN5c3RlbT4+ID0gbmV3IFNldChcclxuXHRcdFx0Wy4uLmVkZ2VzXVxyXG5cdFx0XHRcdC5maWx0ZXIodiA9PiB2WzFdLnNpemUgPT0gMClcclxuXHRcdFx0XHQubWFwKHYgPT4gdlswXSlcclxuXHRcdClcclxuXHJcblx0XHR3aGlsZShzZXQuc2l6ZSA+IDApIHtcclxuXHRcdFx0bGV0IGl0ID0gc2V0W1N5bWJvbC5pdGVyYXRvcl0oKVxyXG5cclxuXHRcdFx0bGV0IHt2YWx1ZTogbn06IHt2YWx1ZTogQ29uc3RydWN0b3I8U3lzdGVtPn0gPSBpdC5uZXh0KClcclxuXHRcdFx0bGlzdC5wdXNoKG4pXHJcblx0XHRcdHNldC5kZWxldGUobilcclxuXHJcblx0XHRcdGZvcihsZXQgbSBvZiBbLi4uZWRnZXNdLmZpbHRlcih2ID0+IHZbMV0uaGFzKG4pKS5tYXAodiA9PiB2WzBdKSkge1xyXG5cdFx0XHRcdGxldCBpbmNvbWluZyA9IGVkZ2VzLmdldChtKVxyXG5cdFx0XHRcdGluY29taW5nLmRlbGV0ZShuKVxyXG5cclxuXHRcdFx0XHRpZihpbmNvbWluZy5zaXplID09IDApXHJcblx0XHRcdFx0XHRzZXQuYWRkKG0pXHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGlmKGVkZ2VzLmdldChuKS5zaXplID09IDApXHJcblx0XHRcdFx0ZWRnZXMuZGVsZXRlKG4pXHJcblx0XHR9XHJcblxyXG5cdFx0aWYoZWRnZXMuc2l6ZSA+IDApIHtcclxuXHRcdFx0bGV0IHMgPSBcIkNpcmN1bGFyYWx5IGRlcGVuZGVudCBzeXN0ZW1zIGRldGVjdGVkXCJcclxuXHRcdFx0O1suLi5lZGdlc10uZm9yRWFjaCh2ID0+IFsuLi52WzFdXS5mb3JFYWNoKGZyb20gPT4gcyArPSBgXFxuXFx0JHtmcm9tLm5hbWV9IC0+ICR7dlswXS5uYW1lfWApKVxyXG5cclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKHMpXHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIFsuLi50aGlzLnJlZ2lzdHJ5LnZhbHVlcygpXS5zb3J0KChhLCBiKSA9PiB7XHJcblx0XHRcdGxldCBjdG9yQSA9IGEuY29uc3RydWN0b3IgYXMgQ29uc3RydWN0b3I8U3lzdGVtPlxyXG5cdFx0XHRsZXQgY3RvckIgPSBiLmNvbnN0cnVjdG9yIGFzIENvbnN0cnVjdG9yPFN5c3RlbT5cclxuXHJcblx0XHRcdHJldHVybiBsaXN0LmluZGV4T2YoY3RvckEpIC0gbGlzdC5pbmRleE9mKGN0b3JCKVxyXG5cdFx0fSkudmFsdWVzKClcclxuXHR9XHJcbn0iXX0=