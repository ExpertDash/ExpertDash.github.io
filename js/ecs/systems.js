"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Manages all systems
 */
class Systems {
    constructor() {
        this.registry = new Map();
        this.dependencies = new Map();
    }
    /**
     * Add a new system
     * @param systems System classe or instance
     */
    add(system, order = {}) {
        let ctor;
        let instance;
        switch (typeof system) {
            case "function":
                ctor = system;
                instance = new ctor();
                break;
            case "object":
                instance = system;
                ctor = instance.constructor;
                break;
        }
        if (this.registry.has(ctor))
            throw new Error(`'${ctor.name}' already present in this set of systems`);
        this.registry.set(ctor, instance);
        let addDependencies = (sys, deps) => {
            let set;
            if (this.dependencies.has(sys))
                set = this.dependencies.get(sys);
            else {
                set = new Set();
                this.dependencies.set(sys, set);
            }
            for (let ctor of deps)
                set.add(ctor);
        };
        addDependencies(ctor, order.after ?? []);
        if (order.before)
            for (let system of order.before)
                addDependencies(system, [ctor]);
    }
    /**
     * Gets the system instance
     * @param ctor System class
     */
    get(ctor) {
        return this.registry.get(ctor);
    }
    /**
     * Remove existing systems
     * @param ctors System classes
     */
    remove(...ctors) {
        for (let ctor of ctors)
            this.registry.delete(ctor);
    }
    /**
     * Generates an iterator for the system instances with an order considering dependencies
     */
    [Symbol.iterator]() {
        let edges = new Map(this.dependencies);
        let list = [];
        let set = new Set([...edges]
            .filter(v => v[1].size == 0)
            .map(v => v[0]));
        while (set.size > 0) {
            let it = set[Symbol.iterator]();
            let { value: n } = it.next();
            list.push(n);
            set.delete(n);
            for (let m of [...edges].filter(v => v[1].has(n)).map(v => v[0])) {
                let incoming = edges.get(m);
                incoming.delete(n);
                if (incoming.size == 0)
                    set.add(m);
            }
            if (edges.get(n).size == 0)
                edges.delete(n);
        }
        if (edges.size > 0) {
            let s = "Circularaly dependent systems detected";
            [...edges].forEach(v => [...v[1]].forEach(from => s += `\n\t${from.name} -> ${v[0].name}`));
            throw new Error(s);
        }
        return [...this.registry.values()].sort((a, b) => {
            let ctorA = a.constructor;
            let ctorB = b.constructor;
            return list.indexOf(ctorA) - list.indexOf(ctorB);
        }).values();
    }
}
exports.default = Systems;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3lzdGVtcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lY3Mvc3lzdGVtcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBOztHQUVHO0FBQ0gsTUFBcUIsT0FBTztJQUE1QjtRQUNrQixhQUFRLEdBQXFDLElBQUksR0FBRyxFQUFFLENBQUE7UUFDdEQsaUJBQVksR0FBdUQsSUFBSSxHQUFHLEVBQUUsQ0FBQTtJQTZHOUYsQ0FBQztJQTNHQTs7O09BR0c7SUFDSSxHQUFHLENBQUMsTUFBNkMsRUFBRSxRQUFzQixFQUFFO1FBQ2pGLElBQUksSUFBeUIsQ0FBQTtRQUM3QixJQUFJLFFBQWdCLENBQUE7UUFFcEIsUUFBTyxPQUFPLE1BQU0sRUFBRTtZQUNyQixLQUFLLFVBQVU7Z0JBQ2QsSUFBSSxHQUFHLE1BQW9DLENBQUE7Z0JBQzNDLFFBQVEsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFBO2dCQUNyQixNQUFLO1lBQ04sS0FBSyxRQUFRO2dCQUNaLFFBQVEsR0FBRyxNQUFnQixDQUFBO2dCQUMzQixJQUFJLEdBQUcsUUFBUSxDQUFDLFdBQWtDLENBQUE7Z0JBQ2xELE1BQUs7U0FDTjtRQUVELElBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSwwQ0FBMEMsQ0FBQyxDQUFBO1FBRXpFLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUVqQyxJQUFJLGVBQWUsR0FBRyxDQUFDLEdBQXdCLEVBQUUsSUFBMkIsRUFBRSxFQUFFO1lBQy9FLElBQUksR0FBNkIsQ0FBQTtZQUVqQyxJQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztnQkFDNUIsR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxD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LENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUU1RixNQUFNLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ2xCO1FBRUQsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNoRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsV0FBa0MsQ0FBQTtZQUNoRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsV0FBa0MsQ0FBQTtZQUVoRCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNqRCxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUNaLENBQUM7Q0FDRDtBQS9HRCwwQkErR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3lzdGVtIGZyb20gXCIuL3N5c3RlbS5qc1wiXHJcblxyXG50eXBlIENvbnN0cnVjdG9yPFQ+ID0gbmV3KC4uLmFyZ3M6IGFueVtdKSA9PiBUXHJcbnR5cGUgRGVmYXVsdENvbnN0cnVjdG9yPFQ+ID0gbmV3KCkgPT4gVFxyXG5cclxuLyoqXHJcbiAqIE1hbmFnZXMgYWxsIHN5c3RlbXNcclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFN5c3RlbXMge1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgcmVnaXN0cnk6IE1hcDxDb25zdHJ1Y3RvcjxTeXN0ZW0+LCBTeXN0ZW0+ID0gbmV3IE1hcCgpXHJcblx0cHJpdmF0ZSByZWFkb25seSBkZXBlbmRlbmNpZXM6IE1hcDxDb25zdHJ1Y3RvcjxTeXN0ZW0+LCBTZXQ8Q29uc3RydWN0b3I8U3lzdGVtPj4+ID0gbmV3IE1hcCgpXHJcblxyXG5cdC8qKlxyXG5cdCAqIEFkZCBhIG5ldyBzeXN0ZW1cclxuXHQgKiBAcGFyYW0gc3lzdGVtcyBTeXN0ZW0gY2xhc3NlIG9yIGluc3RhbmNlXHJcblx0ICovXHJcblx0cHVibGljIGFkZChzeXN0ZW06IChTeXN0ZW0gfCBEZWZhdWx0Q29uc3RydWN0b3I8U3lzdGVtPiksIG9yZGVyOiBTeXN0ZW0uT3JkZXIgPSB7fSk6IHZvaWQge1xyXG5cdFx0bGV0IGN0b3I6IENvbnN0cnVjdG9yPFN5c3RlbT5cclxuXHRcdGxldCBpbnN0YW5jZTogU3lzdGVtXHJcblxyXG5cdFx0c3dpdGNoKHR5cGVvZiBzeXN0ZW0pIHtcclxuXHRcdFx0Y2FzZSBcImZ1bmN0aW9uXCI6XHJcblx0XHRcdFx0Y3RvciA9IHN5c3RlbSBhcyBEZWZhdWx0Q29uc3RydWN0b3I8U3lzdGVtPlxyXG5cdFx0XHRcdGluc3RhbmNlID0gbmV3IGN0b3IoKVxyXG5cdFx0XHRcdGJyZWFrXHJcblx0XHRcdGNhc2UgXCJvYmplY3RcIjpcclxuXHRcdFx0XHRpbnN0YW5jZSA9IHN5c3RlbSBhcyBTeXN0ZW1cclxuXHRcdFx0XHRjdG9yID0gaW5zdGFuY2UuY29uc3RydWN0b3IgYXMgQ29uc3RydWN0b3I8U3lzdGVtPlxyXG5cdFx0XHRcdGJyZWFrXHJcblx0XHR9XHJcblxyXG5cdFx0aWYodGhpcy5yZWdpc3RyeS5oYXMoY3RvcikpXHJcblx0XHRcdHRocm93IG5ldyBFcnJvcihgJyR7Y3Rvci5uYW1lfScgYWxyZWFkeSBwcmVzZW50IGluIHRoaXMgc2V0IG9mIHN5c3RlbXNgKVxyXG5cclxuXHRcdHRoaXMucmVnaXN0cnkuc2V0KGN0b3IsIGluc3RhbmNlKVxyXG5cclxuXHRcdGxldCBhZGREZXBlbmRlbmNpZXMgPSAoc3lzOiBDb25zdHJ1Y3RvcjxTeXN0ZW0+LCBkZXBzOiBDb25zdHJ1Y3RvcjxTeXN0ZW0+W10pID0+IHtcclxuXHRcdFx0bGV0IHNldDogU2V0PENvbnN0cnVjdG9yPFN5c3RlbT4+XHJcblxyXG5cdFx0XHRpZih0aGlzLmRlcGVuZGVuY2llcy5oYXMoc3lzKSlcclxuXHRcdFx0XHRzZXQgPSB0aGlzLmRlcGVuZGVuY2llcy5nZXQoc3lzKVxyXG5cdFx0XHRlbHNlIHtcclxuXHRcdFx0XHRzZXQgPSBuZXcgU2V0KClcclxuXHRcdFx0XHR0aGlzLmRlcGVuZGVuY2llcy5zZXQoc3lzLCBzZXQpXHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGZvcihsZXQgY3RvciBvZiBkZXBzKVxyXG5cdFx0XHRcdHNldC5hZGQoY3RvcilcclxuXHRcdH1cclxuXHJcblx0XHRhZGREZXBlbmRlbmNpZXMoY3Rvciwgb3JkZXIuYWZ0ZXIgPz8gW10pXHJcblxyXG5cdFx0aWYob3JkZXIuYmVmb3JlKVxyXG5cdFx0XHRmb3IobGV0IHN5c3RlbSBvZiBvcmRlci5iZWZvcmUpXHJcblx0XHRcdFx0YWRkRGVwZW5kZW5jaWVzKHN5c3RlbSwgW2N0b3JdKVxyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogR2V0cyB0aGUgc3lzdGVtIGluc3RhbmNlXHJcblx0ICogQHBhcmFtIGN0b3IgU3lzdGVtIGNsYXNzXHJcblx0ICovXHJcblx0cHVibGljIGdldDxUIGV4dGVuZHMgU3lzdGVtPihjdG9yOiBDb25zdHJ1Y3RvcjxUPik6IFQge1xyXG5cdFx0cmV0dXJuIHRoaXMucmVnaXN0cnkuZ2V0KGN0b3IpIGFzIFRcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIFJlbW92ZSBleGlzdGluZyBzeXN0ZW1zXHJcblx0ICogQHBhcmFtIGN0b3JzIFN5c3RlbSBjbGFzc2VzXHJcblx0ICovXHJcblx0cHVibGljIHJlbW92ZSguLi5jdG9yczogQ29uc3RydWN0b3I8U3lzdGVtPltdKTogdm9pZCB7XHJcblx0XHRmb3IobGV0IGN0b3Igb2YgY3RvcnMpXHJcblx0XHRcdHRoaXMucmVnaXN0cnkuZGVsZXRlKGN0b3IpXHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiBHZW5lcmF0ZXMgYW4gaXRlcmF0b3IgZm9yIHRoZSBzeXN0ZW0gaW5zdGFuY2VzIHdpdGggYW4gb3JkZXIgY29uc2lkZXJpbmcgZGVwZW5kZW5jaWVzXHJcblx0ICovXHJcblx0cHVibGljIFtTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhYmxlSXRlcmF0b3I8U3lzdGVtPiB7XHJcblx0XHRsZXQgZWRnZXMgPSBuZXcgTWFwPENvbnN0cnVjdG9yPFN5c3RlbT4sIFNldDxDb25zdHJ1Y3RvcjxTeXN0ZW0+Pj4odGhpcy5kZXBlbmRlbmNpZXMpXHJcblx0XHRsZXQgbGlzdDogQ29uc3RydWN0b3I8U3lzdGVtPltdID0gW11cclxuXHRcdGxldCBzZXQ6IFNldDxDb25zdHJ1Y3RvcjxTeXN0ZW0+PiA9IG5ldyBTZXQoXHJcblx0XHRcdFsuLi5lZGdlc11cclxuXHRcdFx0XHQuZmlsdGVyKHYgPT4gdlsxXS5zaXplID09IDApXHJcblx0XHRcdFx0Lm1hcCh2ID0+IHZbMF0pXHJcblx0XHQpXHJcblxyXG5cdFx0d2hpbGUoc2V0LnNpemUgPiAwKSB7XHJcblx0XHRcdGxldCBpdCA9IHNldFtTeW1ib2wuaXRlcmF0b3JdKClcclxuXHJcblx0XHRcdGxldCB7dmFsdWU6IG59OiB7dmFsdWU6IENvbnN0cnVjdG9yPFN5c3RlbT59ID0gaXQubmV4dCgpXHJcblx0XHRcdGxpc3QucHVzaChuKVxyXG5cdFx0XHRzZXQuZGVsZXRlKG4pXHJcblxyXG5cdFx0XHRmb3IobGV0IG0gb2YgWy4uLmVkZ2VzXS5maWx0ZXIodiA9PiB2WzFdLmhhcyhuKSkubWFwKHYgPT4gdlswXSkpIHtcclxuXHRcdFx0XHRsZXQgaW5jb21pbmcgPSBlZGdlcy5nZXQobSlcclxuXHRcdFx0XHRpbmNvbWluZy5kZWxldGUobilcclxuXHJcblx0XHRcdFx0aWYoaW5jb21pbmcuc2l6ZSA9PSAwKVxyXG5cdFx0XHRcdFx0c2V0LmFkZChtKVxyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRpZihlZGdlcy5nZXQobikuc2l6ZSA9PSAwKVxyXG5cdFx0XHRcdGVkZ2VzLmRlbGV0ZShuKVxyXG5cdFx0fVxyXG5cclxuXHRcdGlmKGVkZ2VzLnNpemUgPiAwKSB7XHJcblx0XHRcdGxldCBzID0gXCJDaXJjdWxhcmFseSBkZXBlbmRlbnQgc3lzdGVtcyBkZXRlY3RlZFwiXHJcblx0XHRcdDtbLi4uZWRnZXNdLmZvckVhY2godiA9PiBbLi4udlsxXV0uZm9yRWFjaChmcm9tID0+IHMgKz0gYFxcblxcdCR7ZnJvbS5uYW1lfSAtPiAke3ZbMF0ubmFtZX1gKSlcclxuXHJcblx0XHRcdHRocm93IG5ldyBFcnJvcihzKVxyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiBbLi4udGhpcy5yZWdpc3RyeS52YWx1ZXMoKV0uc29ydCgoYSwgYikgPT4ge1xyXG5cdFx0XHRsZXQgY3RvckEgPSBhLmNvbnN0cnVjdG9yIGFzIENvbnN0cnVjdG9yPFN5c3RlbT5cclxuXHRcdFx0bGV0IGN0b3JCID0gYi5jb25zdHJ1Y3RvciBhcyBDb25zdHJ1Y3RvcjxTeXN0ZW0+XHJcblxyXG5cdFx0XHRyZXR1cm4gbGlzdC5pbmRleE9mKGN0b3JBKSAtIGxpc3QuaW5kZXhPZihjdG9yQilcclxuXHRcdH0pLnZhbHVlcygpXHJcblx0fVxyXG59Il19