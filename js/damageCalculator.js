import "./argMinMax.js";
import "https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js";
import Generate from "./generate.js";
export class DamageCalculator {
    canvas;
    chart;
    constructor(canvas) {
        this.canvas = canvas;
    }
    calculate({ health, range = 0, gun }) {
        let result = {
            rawBullets: [],
            rawDamageDealt: [],
            bullets: [],
            damageDealt: [],
            trueAccuracies: [],
            deviations: []
        };
        function damager(zone) {
            return 1 / zone.damage * zone.accuracy * health;
        }
        function rounder(value) {
            return Math.max(0, Math.floor(value));
        }
        function getTotalDamage() {
            return result.damageDealt.reduce((a, b) => a + b, 0);
        }
        function calc() {
            result.damageDealt = gun.profile.map((v, i) => result.bullets[i] * v.damage);
            result.trueAccuracies = result.bullets.map(v => v / result.bullets.reduce((a, b) => a + b, 0));
            result.deviations = gun.profile.map((v, i) => result.trueAccuracies[i] - v.accuracy);
            console.log("damageDealt", result.damageDealt);
            console.log("trueAccuracies", result.trueAccuracies);
            console.log("deviations", result.deviations);
            console.log("");
        }
        result.rawBullets = gun.profile.map(zone => damager(zone));
        result.rawDamageDealt = gun.profile.map((v, i) => result.rawBullets[i] * v.damage);
        result.bullets = result.rawBullets.map(v => rounder(v));
        calc();
        let maxIterations = 100;
        let iterations = 0;
        while (getTotalDamage() < health && ++iterations <= maxIterations) {
            // let highestDeviationIndex = argmax(result.deviations.map(v => Math.abs(v)))
            let highestDeviationIndex = result.deviations.indexOf([...result.deviations].sort((a, b) => {
                if (a < 0 && b >= 0)
                    return a;
                if (b < 0 && a >= 0)
                    return b;
                if (a >= 0 && b >= 0)
                    return a - b;
                if (a < 0 && b < 0)
                    return Math.abs(a) - Math.abs(b);
                return 0;
            })[0]);
            result.bullets[highestDeviationIndex] += 1;
            calc();
        }
        return result;
    }
    visualize({ health, range = 0, gun }) {
        let result = this.calculate({
            health: health,
            range: range,
            gun: gun
        });
        let totalDamage = result.damageDealt.reduce((a, b) => a + b, 0);
        let colors = gun.profile.map(zones => [Math.round(Generate.range(60, 200)), Math.round(Generate.range(60, 200)), Math.round(Generate.range(60, 200))]);
        if (this.chart) {
            this.chart.destroy();
            this.chart = null;
        }
        //@ts-ignore
        this.chart = new Chart(this.canvas.getContext("2d"), {
            type: "bar",
            data: {
                labels: gun.profile.map(zone => zone.name),
                datasets: [{
                        label: `Total Damage: ${totalDamage}`,
                        data: result.damageDealt,
                        backgroundColor: gun.profile.map((_, i) => `rgba(${colors[i][0]}, ${colors[i][1]}, ${colors[i][2]}, 0.2)`),
                        borderColor: gun.profile.map((_, i) => `rgba(${colors[i][0]}, ${colors[i][1]}, ${colors[i][2]}, 1)`),
                        borderWidth: 1
                    }]
            },
            options: {
                responsive: false,
                // responsive: true,
                // maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: health
                    }
                }
            }
        });
        return result;
    }
}
export default DamageCalculator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFtYWdlQ2FsY3VsYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9kYW1hZ2VDYWxjdWxhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQXFCLGdCQUFnQixDQUFBO0FBQ3JDLE9BQU8sK0RBQStELENBQUE7QUFDdEUsT0FBTyxRQUFRLE1BQU0sZUFBZSxDQUFBO0FBRXBDLE1BQU0sT0FBTyxnQkFBZ0I7SUFDcEIsTUFBTSxDQUFtQjtJQUN6QixLQUFLLENBQUs7SUFFbEIsWUFBbUIsTUFBeUI7UUFDM0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7SUFDckIsQ0FBQztJQUVNLFNBQVMsQ0FBQyxFQUFDLE1BQU0sRUFBRSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBOEI7UUFDckUsSUFBSSxNQUFNLEdBQTRCO1lBQ3JDLFVBQVUsRUFBRSxFQUFFO1lBQ2QsY0FBYyxFQUFFLEVBQUU7WUFDbEIsT0FBTyxFQUFFLEVBQUU7WUFDWCxXQUFXLEVBQUUsRUFBRTtZQUNmLGNBQWMsRUFBRSxFQUFFO1lBQ2xCLFVBQVUsRUFBRSxFQUFFO1NBQ2QsQ0FBQTtRQUVELFNBQVMsT0FBTyxDQUFDLElBQStCO1lBQy9DLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUE7UUFDaEQsQ0FBQztRQUVELFNBQVMsT0FBTyxDQUFDLEtBQWE7WUFDN0IsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDdEMsQ0FBQztRQUVELFNBQVMsY0FBYztZQUN0QixPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNyRCxDQUFDO1FB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Q0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7YXJnbWF4fSBmcm9tIFwiLi9hcmdNaW5NYXguanNcIlxuaW1wb3J0IFwiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9jaGFydC5qc0AzLjUuMS9kaXN0L2NoYXJ0Lm1pbi5qc1wiXG5pbXBvcnQgR2VuZXJhdGUgZnJvbSBcIi4vZ2VuZXJhdGUuanNcIlxuXG5leHBvcnQgY2xhc3MgRGFtYWdlQ2FsY3VsYXRvciB7XG5cdHByaXZhdGUgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudFxuXHRwcml2YXRlIGNoYXJ0OiBhbnlcblxuXHRwdWJsaWMgY29uc3RydWN0b3IoY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCkge1xuXHRcdHRoaXMuY2FudmFzID0gY2FudmFzXG5cdH1cblxuXHRwdWJsaWMgY2FsY3VsYXRlKHtoZWFsdGgsIHJhbmdlID0gMCwgZ3VufTogRGFtYWdlQ2FsY3VsYXRvci5EZXNjcmlwdG9yKTogRGFtYWdlQ2FsY3VsYXRvci5SZXN1bHQge1xuXHRcdGxldCByZXN1bHQ6IERhbWFnZUNhbGN1bGF0b3IuUmVzdWx0ID0ge1xuXHRcdFx0cmF3QnVsbGV0czogW10sXG5cdFx0XHRyYXdEYW1hZ2VEZWFsdDogW10sXG5cdFx0XHRidWxsZXRzOiBbXSxcblx0XHRcdGRhbWFnZURlYWx0OiBbXSxcblx0XHRcdHRydWVBY2N1cmFjaWVzOiBbXSxcblx0XHRcdGRldmlhdGlvbnM6IFtdXG5cdFx0fVxuXG5cdFx0ZnVuY3Rpb24gZGFtYWdlcih6b25lOiBEYW1hZ2VDYWxjdWxhdG9yLkd1bi5ab25lKSB7XG5cdFx0XHRyZXR1cm4gMSAvIHpvbmUuZGFtYWdlICogem9uZS5hY2N1cmFjeSAqIGhlYWx0aFxuXHRcdH1cblxuXHRcdGZ1bmN0aW9uIHJvdW5kZXIodmFsdWU6IG51bWJlcikge1xuXHRcdFx0cmV0dXJuIE1hdGgubWF4KDAsIE1hdGguZmxvb3IodmFsdWUpKVxuXHRcdH1cblxuXHRcdGZ1bmN0aW9uIGdldFRvdGFsRGFtYWdlKCk6IG51bWJlciB7XG5cdFx0XHRyZXR1cm4gcmVzdWx0LmRhbWFnZURlYWx0LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApXG5cdFx0fVxuXG5cdFx0ZnVuY3Rpb24gY2FsYygpOiB2b2lkIHtcblx0XHRcdHJlc3VsdC5kYW1hZ2VEZWFsdCA9IGd1bi5wcm9maWxlLm1hcCgodiwgaSkgPT4gcmVzdWx0LmJ1bGxldHNbaV0gKiB2LmRhbWFnZSlcblx0XHRcdHJlc3VsdC50cnVlQWNjdXJhY2llcyA9IHJlc3VsdC5idWxsZXRzLm1hcCh2ID0+IHYgLyByZXN1bHQuYnVsbGV0cy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSlcblx0XHRcdHJlc3VsdC5kZXZpYXRpb25zID0gZ3VuLnByb2ZpbGUubWFwKCh2LCBpKSA9PiByZXN1bHQudHJ1ZUFjY3VyYWNpZXNbaV0gLSB2LmFjY3VyYWN5KVxuXG5cdFx0XHRjb25zb2xlLmxvZyhcImRhbWFnZURlYWx0XCIsIHJlc3VsdC5kYW1hZ2VEZWFsdClcblx0XHRcdGNvbnNvbGUubG9nKFwidHJ1ZUFjY3VyYWNpZXNcIiwgcmVzdWx0LnRydWVBY2N1cmFjaWVzKVxuXHRcdFx0Y29uc29sZS5sb2coXCJkZXZpYXRpb25zXCIsIHJlc3VsdC5kZXZpYXRpb25zKVxuXHRcdFx0Y29uc29sZS5sb2coXCJcIilcblx0XHR9XG5cblx0XHRyZXN1bHQucmF3QnVsbGV0cyA9IGd1bi5wcm9maWxlLm1hcCh6b25lID0+IGRhbWFnZXIoem9uZSkpXG5cdFx0cmVzdWx0LnJhd0RhbWFnZURlYWx0ID0gZ3VuLnByb2ZpbGUubWFwKCh2LCBpKSA9PiByZXN1bHQucmF3QnVsbGV0c1tpXSAqIHYuZGFtYWdlKVxuXHRcdHJlc3VsdC5idWxsZXRzID0gcmVzdWx0LnJhd0J1bGxldHMubWFwKHYgPT4gcm91bmRlcih2KSlcblx0XHRjYWxjKClcblxuXHRcdGxldCBtYXhJdGVyYXRpb25zID0gMTAwXG5cdFx0bGV0IGl0ZXJhdGlvbnMgPSAwXG5cblx0XHR3aGlsZShnZXRUb3RhbERhbWFnZSgpIDwgaGVhbHRoICYmICsraXRlcmF0aW9ucyA8PSBtYXhJdGVyYXRpb25zKSB7XG5cdFx0XHQvLyBsZXQgaGlnaGVzdERldmlhdGlvbkluZGV4ID0gYXJnbWF4KHJlc3VsdC5kZXZpYXRpb25zLm1hcCh2ID0+IE1hdGguYWJzKHYpKSlcblx0XHRcdGxldCBoaWdoZXN0RGV2aWF0aW9uSW5kZXggPSByZXN1bHQuZGV2aWF0aW9ucy5pbmRleE9mKFsuLi5yZXN1bHQuZGV2aWF0aW9uc10uc29ydCgoYSwgYikgPT4ge1xuXHRcdFx0XHRpZihhIDwgMCAmJiBiID49IDApXG5cdFx0XHRcdFx0cmV0dXJuIGFcblx0XHRcdFx0aWYoYiA8IDAgJiYgYSA+PSAwKVxuXHRcdFx0XHRcdHJldHVybiBiXG5cdFx0XHRcdGlmKGEgPj0gMCAmJiBiID49IDApXG5cdFx0XHRcdFx0cmV0dXJuIGEgLSBiXG5cdFx0XHRcdGlmKGEgPCAwICYmIGIgPCAwKVxuXHRcdFx0XHRcdHJldHVybiBNYXRoLmFicyhhKSAtIE1hdGguYWJzKGIpXG5cblx0XHRcdFx0cmV0dXJuIDBcblx0XHRcdH0pWzBdKVxuXHRcdFx0cmVzdWx0LmJ1bGxldHNbaGlnaGVzdERldmlhdGlvbkluZGV4XSArPSAxXG5cdFx0XHRjYWxjKClcblx0XHR9XG5cblx0XHRyZXR1cm4gcmVzdWx0XG5cdH1cblxuXHRwdWJsaWMgdmlzdWFsaXplKHtoZWFsdGgsIHJhbmdlID0gMCwgZ3VufTogRGFtYWdlQ2FsY3VsYXRvci5EZXNjcmlwdG9yKTogRGFtYWdlQ2FsY3VsYXRvci5SZXN1bHQge1xuXHRcdGxldCByZXN1bHQgPSB0aGlzLmNhbGN1bGF0ZSh7XG5cdFx0XHRoZWFsdGg6IGhlYWx0aCxcblx0XHRcdHJhbmdlOiByYW5nZSxcblx0XHRcdGd1bjogZ3VuXG5cdFx0fSlcblxuXHRcdGxldCB0b3RhbERhbWFnZSA9IHJlc3VsdC5kYW1hZ2VEZWFsdC5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKVxuXHRcdGxldCBjb2xvcnMgPSBndW4ucHJvZmlsZS5tYXAoem9uZXMgPT4gW01hdGgucm91bmQoR2VuZXJhdGUucmFuZ2UoNjAsIDIwMCkpLCBNYXRoLnJvdW5kKEdlbmVyYXRlLnJhbmdlKDYwLCAyMDApKSwgTWF0aC5yb3VuZChHZW5lcmF0ZS5yYW5nZSg2MCwgMjAwKSldKVxuXG5cdFx0aWYodGhpcy5jaGFydCkge1xuXHRcdFx0dGhpcy5jaGFydC5kZXN0cm95KClcblx0XHRcdHRoaXMuY2hhcnQgPSBudWxsXG5cdFx0fVxuXG5cdFx0Ly9AdHMtaWdub3JlXG5cdFx0dGhpcy5jaGFydCA9IG5ldyBDaGFydCh0aGlzLmNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIiksIHtcblx0XHRcdHR5cGU6IFwiYmFyXCIsXG5cdFx0XHRkYXRhOiB7XG5cdFx0XHRcdGxhYmVsczogZ3VuLnByb2ZpbGUubWFwKHpvbmUgPT4gem9uZS5uYW1lKSxcblx0XHRcdFx0ZGF0YXNldHM6IFt7XG5cdFx0XHRcdFx0bGFiZWw6IGBUb3RhbCBEYW1hZ2U6ICR7dG90YWxEYW1hZ2V9YCxcblx0XHRcdFx0XHRkYXRhOiByZXN1bHQuZGFtYWdlRGVhbHQsXG5cdFx0XHRcdFx0YmFja2dyb3VuZENvbG9yOiBndW4ucHJvZmlsZS5tYXAoKF8sIGkpID0+IGByZ2JhKCR7Y29sb3JzW2ldWzBdfSwgJHtjb2xvcnNbaV1bMV19LCAke2NvbG9yc1tpXVsyXX0sIDAuMilgKSxcblx0XHRcdFx0XHRib3JkZXJDb2xvcjogZ3VuLnByb2ZpbGUubWFwKChfLCBpKSA9PiBgcmdiYSgke2NvbG9yc1tpXVswXX0sICR7Y29sb3JzW2ldWzFdfSwgJHtjb2xvcnNbaV1bMl19LCAxKWApLFxuXHRcdFx0XHRcdGJvcmRlcldpZHRoOiAxXG5cdFx0XHRcdH1dXG5cdFx0XHR9LFxuXHRcdFx0b3B0aW9uczoge1xuXHRcdFx0XHRyZXNwb25zaXZlOiBmYWxzZSxcblx0XHRcdFx0Ly8gcmVzcG9uc2l2ZTogdHJ1ZSxcblx0XHRcdFx0Ly8gbWFpbnRhaW5Bc3BlY3RSYXRpbzogZmFsc2UsXG5cdFx0XHRcdHNjYWxlczoge1xuXHRcdFx0XHRcdHk6IHtcblx0XHRcdFx0XHRcdGJlZ2luQXRaZXJvOiB0cnVlLFxuXHRcdFx0XHRcdFx0c3VnZ2VzdGVkTWF4OiBoZWFsdGhcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KVxuXG5cdFx0cmV0dXJuIHJlc3VsdFxuXHR9XG59XG5cbmV4cG9ydCBuYW1lc3BhY2UgRGFtYWdlQ2FsY3VsYXRvciB7XG5cdGV4cG9ydCBpbnRlcmZhY2UgRGVzY3JpcHRvciB7XG5cdFx0aGVhbHRoOiBudW1iZXJcblx0XHRyYW5nZTogbnVtYmVyXG5cdFx0Z3VuOiBHdW5cblx0fVxuXG5cdGV4cG9ydCBpbnRlcmZhY2UgR3VuIHtcblx0XHQvKiogRmlyZSByYXRlIG9mIHRoZSB3ZWFwb24gKi9cblx0XHRmaXJlUmF0ZTogbnVtYmVyXG5cblx0XHQvKiogT3BlbiBib2x0IGRlbGF5IG9mIHRoZSB3ZWFwb24gKi9cblx0XHRib2x0RGVsYXk6IG51bWJlclxuXG5cdFx0LyoqIERhbWFnZSBhbmQgYWNjdXJhY3kgYXQgZWFjaCB6b25lICovXG5cdFx0cHJvZmlsZTogR3VuLlpvbmVbXVxuXHR9XG5cblx0ZXhwb3J0IG5hbWVzcGFjZSBHdW4ge1xuXHRcdGV4cG9ydCBpbnRlcmZhY2UgWm9uZSB7XG5cdFx0XHQvKiogWm9uZSBkYW1hZ2UgaXMgZGVhbHQgdG8gKi9cblx0XHRcdG5hbWU6IHN0cmluZ1xuXG5cdFx0XHQvKiogRGFtYWdlIGRlYWx0IHRvIHRoZSBhcmVhICovXG5cdFx0XHRkYW1hZ2U6IG51bWJlclxuXG5cdFx0XHQvKiogUmF0aW8gb2Ygc2hvdHMgcmVhY2hpbmcgdGhlIGFyZWEgKHRvdGFsIGFjY3VyYWN5IG11c3QgYmUgMTAwJSkgKi9cblx0XHRcdGFjY3VyYWN5OiBudW1iZXJcblx0XHR9XG5cdH1cblxuXHRleHBvcnQgaW50ZXJmYWNlIFJlc3VsdCB7XG5cdFx0cmF3QnVsbGV0czogbnVtYmVyW11cblx0XHRyYXdEYW1hZ2VEZWFsdDogbnVtYmVyW11cblx0XHRidWxsZXRzOiBudW1iZXJbXVxuXHRcdGRhbWFnZURlYWx0OiBudW1iZXJbXVxuXHRcdHRydWVBY2N1cmFjaWVzOiBudW1iZXJbXVxuXHRcdGRldmlhdGlvbnM6IG51bWJlcltdXG5cdH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRGFtYWdlQ2FsY3VsYXRvciJdfQ==